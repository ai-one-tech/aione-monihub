## 范围与排除
- 接入审计的表：instances、instance_tasks、users、projects、configs、roles、permissions、applications、user_roles、role_permissions、password_reset_tokens（仅记录事件，不含敏感数据）。
- 排除：deployments（无需审计）。

## 目标与展示
- 所有增删改在持久化成功后写一条审计日志（log_source=Audit，log_type=Operation），前端页面 `/logs/operations` 自动显示。
- 过滤/分页沿用现有实现，无需前端改动（apps/frontend/src/routes/_authenticated/logs/operations.tsx:23–41, 66–71）。

## 通用实现
- 在各模块 Handler 的 create/update/delete 成功后，调用 `record_audit_log(db, table, operation, user_id, ip, trace_id, before, after)`（apps/server/src/audit/handlers.rs:120–169）。
- 参数规则：
  - `table`：使用对应业务表名（如 `projects`）。
  - `operation`：`create|update|delete`。
  - `user_id`：从鉴权上下文取当前操作者。
  - `ip`：`req.connection_info().realip_remote_addr()`。
  - `trace_id`：从请求头 `x-trace-id`。
  - `before/after`：使用保存前后的 JSON 快照；`diff` 将由函数自动生成。

## 模块级接入点
- instances（apps/server/src/instances/handlers.rs）
  - create：插入后记 `table=instances, operation=create`，`after` 为实例快照。
  - update / update_config：更新后记 `operation=update`，`before/after` 为快照。
  - delete：删除后记 `operation=delete`，`before` 为删除前快照。
- instance_tasks（apps/server/src/instance_tasks/handlers.rs）
  - create/update/delete：在任务创建、状态更新、删除后记录对应操作，快照包含任务核心字段（id、instance_id、status、payload 等）。
- users（apps/server/src/users/handlers.rs）
  - 已有：create/update/delete 的审计（239–261, 474–504, 564–586）。保留不变。
- projects（apps/server/src/projects/handlers.rs）
  - create/update/delete：比照 users 模式接入。
- configs（apps/server/src/configs/handlers.rs）
  - create/delete：接入；如存在更新接口或内部更新，统一在持久化处接入。
- roles（apps/server/src/roles/handlers.rs）
  - create/update/delete：接入，并在更新变更角色基础字段时记录快照。
- permissions（apps/server/src/permissions/handlers.rs）
  - create/update/delete：接入。
- applications（apps/server/src/applications/handlers.rs）
  - create/update/delete：接入。
- password_reset_tokens（与认证流程相关）
  - 事件型审计：记录“令牌生成”和“令牌核销”事件，`table=password_reset_tokens, operation=create|delete`；`before/after` 不包含令牌明文，仅记录关联用户与时间戳。

## 特殊处理：user_roles 与 role_permissions
- 场景：采用“清空后重建”的覆盖更新，需要把“删除前的集合”和“新增后的集合”作为审计的 `before/after`。
- user_roles（apps/server/src/users/handlers.rs）
  - 在更新用户角色流程中：
    - 变更前查询该用户的角色名/ID集合作为 `before`（在 `UserRoles::delete_many` 之前获取）。
    - 变更后收集新分配的角色名/ID集合作为 `after`（在插入完成后获取）。
    - 追加一条审计：`table=user_roles, operation=update`，`before={ roles:[...] }`，`after={ roles:[...] }`。
- role_permissions（apps/server/src/roles/handlers.rs 及 apps/server/src/permissions/handlers.rs）
  - 角色更新或权限分配接口中：
    - 变更前查询该角色的权限名/ID集合作为 `before`。
    - 变更后集合作为 `after`。
    - 记录审计：`table=role_permissions, operation=update`，`before={ permissions:[...] }`，`after={ permissions:[...] }`。

## 安全与数据最小化
- 不记录密码、令牌明文、敏感密钥。
- 对集合型快照仅存放 ID/名称，避免冗余大对象。

## 验证步骤
- 对每个模块执行一次 create/update/delete，检查 `GET /api/audit/logs` 的返回 `pagination.total` 增长，前端页面出现新记录。
- 对用户角色与角色权限变更，打开详情查看 `before/after` 集合正确。

## 交付与变更影响
- 后端：按上述接入点在各 Handler 中加入审计调用；不改动现有 API 契约。
- 前端：无需改动；页面会自动显示审计数据（apps/frontend/src/features/system/logs/operations/components/operations-logs-table.tsx）。

请确认该方案，我将开始在各模块的具体位置加入审计写入，并为 user_roles/role_permissions 按集合前后记录。