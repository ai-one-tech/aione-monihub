## 目标与约束
- 不新增日志上传接口，直接扩展现有 `POST /api/open/instances/report` 以同时接收代理（Java Agent）日志。
- 上报必须携带 `agent_instance_id`，并按现有实例校验范式验证合法性（实例存在、未软删除、未禁用、关联应用存在）。
- 写入 `logs` 表并可按应用与实例区分查询。

## 接口模型扩展
- 位置：`apps/server/src/instance_reports/models.rs`
- 在 `InstanceReportRequest` 中新增可选字段：
  - `agent_logs: Option<Vec<AgentLogItem>>`
  - `AgentLogItem { log_level: String, message: String, context?: serde_json::Value, timestamp?: String }`
- 说明：`agent_logs` 批量承载代理日志；`timestamp` 若为空由服务端填充当前时间；`context` 携带任意扩展键（线程、模块、异常栈等）。
- 可选扩展响应：在 `InstanceReportResponse` 中新增 `log_success_count`、`log_failure_count` 字段用于返回批量处理结果（不破坏现有字段）。

## 处理器扩展
- 位置：`apps/server/src/instance_reports/handlers.rs:20-201`（`report_instance_info`）
- 在完成实例校验/创建与 `instance_records` 插入之后，追加处理：
  - 若 `request.agent_logs` 存在：
    - 通过已取得的 `instance.id` 与 `instance.application_id` 写入 `logs` 表：
      - `id`：`generate_snowflake_id()`
      - `application_id`：`instance.application_id`
      - `log_level`：取 `AgentLogItem.log_level`（默认 `INFO`）
      - `message`：取 `AgentLogItem.message`
      - `log_source`：固定 `"agent:java"`（或 `"agent"`）用于来源区分
      - `timestamp`/`created_at`：解析 `AgentLogItem.timestamp`（RFC3339），失败则使用 `Utc::now()`
      - `context`：合并包含 `agent_instance_id` 与 `instance_id`，并保留客户端传入的 `context`
    - 统计成功/失败条数，填充到响应（若启用）。

## 查询与区分
- 现有查询：`apps/server/src/logs/handlers.rs:get_logs` 已支持 `application_id`（字段名 `user_id`）、`log_source`、时间与关键字过滤。
- 增强建议：在 `apps/server/src/logs/models.rs:12-21` 的 `LogListQuery` 中新增可选参数：`agent_instance_id`、`instance_id`。
  - 在 `get_logs` 中增加 JSON 过滤：`context->>'agent_instance_id' = ?`、`context->>'instance_id' = ?`（SeaORM 通过 `Expr::cust`）。
- 区分策略：
  - 按应用：使用列 `application_id` 直接过滤。
  - 按实例：使用 `context` 中的 `agent_instance_id` 或 `instance_id` 过滤；默认 `log_source="agent:java"` 聚合代理日志。

## 兼容与影响
- 完全复用现有上报接口的应用校验与实例生命周期管理，不改变实例记录与状态更新逻辑。
- 不新增路由或模块；仅在既有处理函数中扩展逻辑与数据模型。
- 前端当前未使用 `/api/logs`；若后续需要 UI 查询代理日志，建议在 `apiClient` 增加查询参数支持（`source`、`agent_instance_id`）。

## 验证点
- 合法实例（Active）批量上报 → `200 OK`，`logs` 表新增记录，`log_source=agent:java`。
- 实例禁用或不存在 → `403 Forbidden`/`404 NotFound`（沿用现有校验范式）。
- `GET /api/logs`：按 `application_id`/`source`，以及新增 `agent_instance_id`/`instance_id` 过滤可命中新日志。

若确认以上方案，我将直接在既有 `report_instance_info` 中追加日志处理，并扩展请求/响应模型与查询参数，确保数据校验与存储一致性。